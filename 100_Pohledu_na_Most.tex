% Nastaveni jazyka -----------------------------------------------------------
\mainlanguage[cz]
\language[cz]
\enableregime[utf]

%\usetypescript[schola]
\usetypescript[gentium]
\setupbodyfont[gentium,11pt]

\setupbodyfontenvironment[default][em=italic]

\setupinteraction[state=start, style=normal, color=blue]

%\setupblank[flexible]

\setuppapersize[A4]

\setuplayout
    [backspace=30mm,
     width=middle,
     topspace=0mm,
     height=middle,
     bottomspace=2cm,
     footer=10mm,
     ]

% Debug
\showframe
\showsetups


% Možnosti pro vnořené uvozovky
\setupdelimitedtext[quotation:1][%
    left={\symbol[leftquotation]},
    right={\symbol[rightquotation]}%
]

\setupdelimitedtext[quotation:2][%
    left={\symbol[leftquote]},
    right={\symbol[rightquote]}%
]

% Makro \uv pro text v uvozovkách (\quotation)
\let\uv\quotation

% Odstavce
% mezery mezi odstavci
\setupwhitespace[none]

% velikost odsazeni
\setupindenting[medium, next]  % none, small, medium, bix, next, first, [rozmer]
\indenting[yes]

% Iniciály

\setupinitial[n=1,continue=yes]

\setuphead[chapter][
  after={\placeinitial},
%  page=no,
]

\setuphead[chapter][
%numberstyle={\switchtobodyfont[64pt]},
number=no
%numbercommand={},%\Cislovani,
%style={\switchtobodyfont[36pt]},
%header=high,
%before={},
%after={\nowhitespace\blank[3*line]},
%command=\MyChapter,
%header=empty,
]

% Makro pro vložení fotografie
\define[1]\foto{%
    
%    \vfill

%    \placefigure[bottom][none]{}{
    \placefigure[none] {} {
       \externalfigure[#1][height=5cm]%
    }
}

% Vzhled obsahu ---------------------------------------------------------------
\setupcombinedlist[content][level=1,alternative=c]
% a -- stranka hned za, b -- stranka na konci radku,
% c -- jako b, ale teckovany radek, d -- jako jeden odstavec

\starttext
% Obsah knihy
\placecontent

\startluacode
    -- Adresář s foty nastaven v Makefile
    PHOTO_DIR = os.getenv("PHOTOS")

    -- Najdi jméno fotografie v souboru na řádku s "Foto"
    function get_image(file)
        for line in io.lines(file) do
            if line:find("Foto") then
                -- print(line)
                -- řetězec za posledním lomítkem je lokální jméno souboru
                img_file = line:gmatch("[^/]+$")()
                if line:match(".jpg") then
                    return img_file
                else
                    -- přidej příponu pokud chybí
                    return img_file .. ".jpg"
                end
            end
        end
    end

    -- Načtení všech souborů v~adresáři vyhovující '201*.tex'
    require "lfs"

    chapters = {}   -- new array
    for file in lfs.dir(".") do
        if file:match("201.*%.tex") then
            table.insert(chapters, file)
         end
    end

    table.sort(chapters)

    for i = 1, #chapters do
        print("Including chapter: " ..  chapters[i])
        img = get_image(chapters[i])
        print("Image: " .. img)
        -- Vlož kapitolu
        tex.print("\\input " .. chapters[i])
        -- Vlož foto
--        tex.print(("\\externalfigure[%s/%s][height=5cm]"):format(PHOTO_DIR, img))
        tex.print(("\\foto{%s/%s}"):format(PHOTO_DIR, img))
    end
\stopluacode

\input doslov.tex

\stoptext
